<!DOCTYPE html>
<html lang="en" x-data="loginPage()" :class="dark ? 'dark' : ''">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIN ‚Äî Sign in</title>
  <meta name="description" content="Cannabis Intel Nexus secure sign-in." />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <!-- Alpine -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

  <script>
    // ‚úÖ Local dev: API on 127.0.0.1:8000
    window.CIN_API_BASE = "http://127.0.0.1:8000";
  </script>

  <style>
    html{scroll-behavior:smooth}
    .glass{backdrop-filter: blur(12px)}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-slate-50 to-indigo-50 dark:from-slate-950 dark:via-slate-950 dark:to-slate-900 text-slate-900 dark:text-slate-100">
  <header class="sticky top-0 z-40 border-b border-slate-200/60 dark:border-slate-800/60 bg-white/70 dark:bg-slate-950/60 glass">
    <div class="max-w-5xl mx-auto h-14 px-4 md:px-6 flex items-center justify-between">
      <div class="flex items-center gap-2 font-extrabold tracking-tight">
        <span class="inline-block w-2.5 h-2.5 rounded-full bg-emerald-500"></span>
        <span class="hover:opacity-90">Cannabis Intel Nexus</span>
      </div>
      <div class="flex items-center gap-2">
        <button @click="toggleTheme" class="px-3 py-1.5 rounded-xl border border-slate-300/80 dark:border-slate-700/80" aria-label="Toggle theme">üåó</button>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-4 md:px-6 py-10">
    <section class="grid lg:grid-cols-2 gap-8 items-start">
      <aside class="order-2 lg:order-1">
        <div class="rounded-3xl p-6 md:p-8 bg-white/80 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 glass">
          <h1 class="text-3xl font-black">Welcome back</h1>
          <p class="mt-2 text-slate-600 dark:text-slate-300">Sign in to access the tools.</p>
          <div class="mt-6 grid grid-cols-2 gap-3">
            <div class="p-3 rounded-xl border border-slate-200 dark:border-slate-800">
              <div class="text-xs text-slate-500">Status</div>
              <div class="font-semibold" :class="apiUp ? 'text-emerald-600' : 'text-amber-600'" x-text="apiUp ? 'API reachable' : 'API pending' "></div>
            </div>
            <div class="p-3 rounded-xl border border-slate-200 dark:border-slate-800">
              <div class="text-xs text-slate-500">Session</div>
              <div class="font-semibold" x-text="session ? 'Active' : 'Not signed in'"></div>
            </div>
          </div>
        </div>
      </aside>

      <section class="order-1 lg:order-2">
        <div class="rounded-3xl p-6 md:p-8 bg-white/80 dark:bg-slate-900/60 border border-slate-200 dark:border-slate-800 glass">
          <div class="flex items-center gap-2 mb-4">
            <button @click="mode='signin'" :class="tabClass('signin')" class="px-3 py-1.5 rounded-xl border">Sign in</button>
            <button @click="mode='signup'" :class="tabClass('signup')" class="px-3 py-1.5 rounded-xl border">Create account</button>
            <button @click="mode='magic'"  :class="tabClass('magic')"  class="ml-auto px-3 py-1.5 rounded-xl border">Magic link</button>
          </div>

          <!-- Sign in -->
          <form x-show="mode==='signin'" @submit.prevent="submitSignin" class="space-y-3">
            <label class="block">
              <span class="text-sm">Email</span>
              <input type="email" x-model="email" required autocomplete="email" class="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label class="block">
              <div class="flex items-center justify-between">
                <span class="text-sm">Password</span>
                <button type="button" @click="mode='magic'" class="text-xs text-emerald-700 dark:text-emerald-300">Use magic link</button>
              </div>
              <div class="mt-1 relative">
                <input :type="showPass ? 'text' : 'password'" x-model="password" required autocomplete="current-password" minlength="9" class="w-full px-3 py-2 pr-10 rounded-xl border" />
                <button type="button" @click="showPass=!showPass" class="absolute right-2 top-1/2 -translate-y-1/2 text-sm">üëÅÔ∏è</button>
              </div>
            </label>
            <div class="flex items-center justify-between text-sm">
              <label class="inline-flex items-center gap-2">
                <input type="checkbox" x-model="remember" class="rounded" />
                <span>Remember this device</span>
              </label>
              <button type="button" @click="mode='reset'" class="text-emerald-700 dark:text-emerald-300">Forgot?</button>
            </div>
            <button class="w-full mt-1 px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Sign in</button>
          </form>

          <!-- Sign up -->
          <form x-show="mode==='signup'" @submit.prevent="submitSignup" class="space-y-3">
            <label class="block">
              <span class="text-sm">Email</span>
              <input type="email" x-model="email" required autocomplete="email" class="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label class="block">
              <span class="text-sm">Password</span>
              <input :type="showPass ? 'text' : 'password'" x-model="password" required minlength="9" class="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <label class="block">
              <span class="text-sm">Invite code <span class="text-slate-400">(optional)</span></span>
              <input x-model="invite" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="If provided" />
            </label>
            <button class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Create account</button>
          </form>

          <!-- Magic link -->
          <form x-show="mode==='magic'" @submit.prevent="submitMagic" class="space-y-3">
            <label class="block">
              <span class="text-sm">Email</span>
              <input type="email" x-model="email" required class="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <div class="text-xs text-slate-500">We'll send a one-time sign-in link valid for 10 minutes.</div>
            <button class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Email me a link</button>
          </form>

          <!-- Reset -->
          <form x-show="mode==='reset'" @submit.prevent="submitReset" class="space-y-3">
            <label class="block">
              <span class="text-sm">Email</span>
              <input type="email" x-model="email" required class="mt-1 w-full px-3 py-2 rounded-xl border" />
            </label>
            <button class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold hover:bg-emerald-700">Send reset link</button>
          </form>

          <p x-show="msg" class="mt-4 text-sm" :class="ok ? 'text-emerald-600' : 'text-rose-600'" x-text="msg"></p>
        </div>
      </section>
    </section>
  </main>

  <script>
    function loginPage(){
      const saved = localStorage.getItem('cinDark');
      return {
        API: (window.CIN_API_BASE || '') + '/auth',
        dark: saved ? saved==='true' : window.matchMedia('(prefers-color-scheme: dark)').matches,
        mode: 'signin',
        email: '',
        password: '',
        invite: '',
        remember: true,
        showPass: false,
        msg: '',
        ok: false,
        session: null,
        apiUp: false,

        tabClass(x){
          return (this.mode===x)
            ? 'border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20'
            : 'border-slate-300 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800'
        },
        toggleTheme(){
          this.dark = !this.dark; document.documentElement.classList.toggle('dark', this.dark);
          localStorage.setItem('cinDark', String(this.dark));
        },
        async ping(){
          try{
            const r = await fetch(this.API + '/ping', { credentials:'include' });
            this.apiUp = r.ok;
          }catch{ this.apiUp=false }
        },
        async submitSignin(){
          this.msg='';
          try{
            const r = await fetch(this.API + '/login', {
              method:'POST',
              credentials:'include',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ email:this.email, password:this.password, remember:this.remember })
            });
            if(!r.ok) throw new Error('Invalid credentials');

            // Verify cookie by calling a protected endpoint
            const me = await fetch(this.API + '/me', { credentials: 'include' });
            if (me.ok) {
              const data = await me.json();
              this.ok = true; this.session = true;
              this.msg = 'Signed in as ' + (data.user_id || '(unknown)');
            } else {
              this.ok = true; this.session = true; this.msg = 'Signed in';
            }
          }catch(e){ this.ok=false; this.msg=e.message || 'Sign-in failed' }
        },
        async submitSignup(){
          this.msg='';
          try{
            const r = await fetch(this.API + '/register', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ email:this.email, password:this.password, invite:this.invite })
            });
            if(!r.ok) throw new Error('Sign-up failed');
            this.ok=true; this.msg='Check your email to verify your account'; this.mode='signin';
          }catch(e){ this.ok=false; this.msg=e.message || 'Sign-up failed' }
        },
        async submitMagic(){
          this.msg='';
          try{
            const r = await fetch(this.API + '/magic', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ email:this.email })
            });
            if(!r.ok) throw new Error('Could not send link');
            this.ok=true; this.msg='Magic link sent (if the email exists)';
          }catch(e){ this.ok=false; this.msg=e.message || 'Magic link failed' }
        },
        async submitReset(){
          this.msg='';
          try{
            const r = await fetch(this.API + '/reset', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ email:this.email })
            });
            if(!r.ok) throw new Error('Reset failed');
            this.ok=true; this.msg='If the email exists, a reset link was sent';
          }catch(e){ this.ok=false; this.msg=e.message || 'Reset failed' }
        },
        async webauthnRegister(){ this.msg='(UI stub) Start WebAuthn registration'; },
        async webauthnLogin(){ this.msg='(UI stub) Start WebAuthn login'; },
        async totpSetup(){ this.msg='(UI stub) Show QR for TOTP'; },

        async init(){ await this.ping(); }
      }
    }
  </script>
</body>
</html>
