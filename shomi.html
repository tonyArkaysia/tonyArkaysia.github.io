<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A_LABS ‚Äî Sh≈çmi: Used Car Truth Meter</title>
  <meta name="description" content="A_LABS Sh≈çmi: transparent longevity odds and maintenance expectations for used cars." />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Init theme before paint
    (() => {
      const saved = localStorage.getItem('theme');
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const dark = saved ? saved === 'dark' : prefers;
      document.documentElement.classList.toggle('dark', dark);
    })();
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { brand: { DEFAULT: '#5fd4a7' } }
        }
      }
    }
  </script>
</head>
<body class="min-h-full bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 selection:bg-brand/30">
  <div class="mx-auto max-w-5xl p-4 sm:p-6 space-y-6">
    <!-- Header -->
    <header class="flex items-center gap-3">
      <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-cyan-400 to-brand shadow"></div>
      <div class="flex-1">
        <h1 class="text-xl font-bold">A_LABS ‚Äî Sh≈çmi</h1>
        <p class="text-sm text-slate-600 dark:text-slate-400">Enriching Humanity Beyond Innovations ‚Ä¢ An A_LABS Product</p>
      </div>
      <button id="themeToggle" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">üåô</button>
    </header>

    <!-- Hero / CTA -->
    <section class="rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 sm:p-8 shadow">
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
        <div class="flex-1">
          <h2 class="text-2xl sm:text-3xl font-extrabold">Find your best used-car match</h2>
          <p class="text-slate-600 dark:text-slate-400 mt-1">Answer a few quick questions. We‚Äôll suggest great fits. Then we show specs, risks, and expected costs ‚Äî transparently.</p>
        </div>
        <button id="start" class="rounded-xl bg-brand px-4 py-3 font-semibold text-slate-900 shadow hover:opacity-90">Find my best deal</button>
      </div>

      <!-- Guided Q&A -->
      <div id="qa" class="mt-6 hidden">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 p-4">
          <div class="flex items-center justify-between">
            <div id="qText" class="font-semibold"></div>
            <div id="qStep" class="text-xs text-slate-500"></div>
          </div>
          <div id="qOptions" class="mt-3 flex flex-wrap gap-2"></div>
          <div class="mt-3 flex gap-2">
            <button id="qBack" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm disabled:opacity-50">Back</button>
            <button id="qSkip" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm">Skip</button>
          </div>
        </div>

        <!-- Suggestions -->
        <div id="picksWrap" class="mt-4 hidden">
          <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Top picks for you</h3>
          <div id="picks" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3"></div>
        </div>
      </div>
    </section>

    <!-- Results card -->
    <section id="resultsCard" class="hidden rounded-2xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-6 sm:p-8 shadow">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-bold" id="selTitle">Selected vehicle</h3>
          <p id="selSub" class="text-slate-600 dark:text-slate-400 text-sm"></p>
        </div>
        <button id="change" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm">Change</button>
      </div>

      <!-- Quick inputs -->
      <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
        <label class="text-sm">
          <span class="block text-slate-600 dark:text-slate-400">Mileage</span>
          <input id="miles" type="number" min="0" step="1000" value="100000" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
        </label>
        <label class="text-sm">
          <span class="block text-slate-600 dark:text-slate-400">Region</span>
          <select id="region" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
            <option value="dry">Dry / Non-rust</option>
            <option value="snow_belt">Snow belt / Coastal</option>
          </select>
        </label>
        <label class="text-sm">
          <span class="block text-slate-600 dark:text-slate-400">Records</span>
          <select id="maint" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
            <option value="excellent">Excellent</option>
            <option value="average" selected>Some</option>
            <option value="poor">Poor</option>
          </select>
        </label>
        <label class="text-sm">
          <span class="block text-slate-600 dark:text-slate-400">CEL / Codes</span>
          <select id="dtc" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </label>
      </div>

      <!-- KPIs -->
      <div class="mt-5 grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">5-Year Survival</div>
          <div id="longevity" class="text-3xl font-extrabold mt-1">‚Äî</div>
          <div id="conf" class="text-xs text-slate-500 dark:text-slate-400 mt-1">‚Äî</div>
        </div>
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Annual Maintenance</div>
          <div id="cost" class="text-3xl font-extrabold mt-1">‚Äî</div>
          <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">¬±20% uncertainty.</div>
        </div>
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
          <div class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Confidence</div>
          <div id="confidence" class="text-3xl font-extrabold mt-1">‚Äî</div>
          <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Better with full service history.</div>
        </div>
      </div>

      <!-- Specs + Flags -->
      <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
        <div class="lg:col-span-2 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
          <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Car Specs</h4>
          <dl id="specs" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm"></dl>
        </div>
        <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
          <h4 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Risk Flags</h4>
          <div id="flags" class="mt-3 space-y-2"></div>
        </div>
      </div>

      <details class="mt-6">
        <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-400">Why these numbers? (show adjustments)</summary>
        <div id="why" class="mt-3 flex flex-wrap gap-2"></div>
      </details>

      <div class="mt-6 text-xs text-slate-500 dark:text-slate-400">
        Data source: Sh≈çmi JSON (specifications). Future: vPIC/IIHS/NHTSA enrichment.
      </div>
    </section>

    <footer class="text-center text-sm text-slate-500 dark:text-slate-400">
      ¬© 2025 A_LABS ‚Äî Arkaysia Labs ‚Ä¢ <a class="text-brand underline-offset-2 hover:underline" href="https://tonyarkaysia.github.io">Visit A_LABS</a>
    </footer>
  </div>

  <script>
    // ===== CONFIG =====
    // point this at your trimmed dataset in the repo
    const DATA_URL = "data/shomi/car_specs_1980_2020_major_makes.json";

    // ===== UTIL =====
    const by = s => document.querySelector(s);
    const el = (tag, cls, html) => { const x=document.createElement(tag); if(cls) x.className=cls; if(html!=null) x.innerHTML=html; return x; };
    const opt = (v, t=v) => { const o=document.createElement("option"); o.value=v; o.textContent=t; return o; };
    const fmt$ = n => "$" + (Math.round(n/10)*10).toLocaleString();

    function resolveCols(cols){
      const lc = cols.map(c=>c.toLowerCase());
      const find = (names) => {
        for(const n of names){
          const ix = lc.indexOf(n.toLowerCase());
          if(ix>=0) return cols[ix];
          for(let j=0;j<cols.length;j++){
            if(lc[j].includes(n.toLowerCase())) return cols[j];
          }
        }
        return null;
      };
      return {
        make: find(["Make","Manufacturer","Brand"]),
        model: find(["Model","Modle","Car","Model Name"]),
        year:  find(["Year","Model Year","Year_from","Year_from "]),
        year_to: find(["Year_to","Year to"]),
        engine: find(["Engine","Engine Info","Engine Type"]),
        trans:  find(["Transmission","Gearbox","Trans"]),
        hp:     find(["Horsepower","HP","Power"]),
        body:   find(["Body","Body_type","Body Style"]),
        fuel:   find(["Fuel Type","Fuel","FuelType"]),
        drive:  find(["Drivetrain","Drive","Drive Type"]),
        cylinders: find(["Cylinders","Cylinder"]),
        disp:   find(["Displacement","Engine Displacement (L)","Liters"]),
        mpgC:   find(["City MPG","MPG City","City_mpg","city_mpg"]),
        mpgH:   find(["Highway MPG","MPG Highway","Highway_mpg","highway_mpg"]),
        msrp:   find(["MSRP","Price","price","List Price"])
      };
    }

    function normalizeRow(row, C){
      const make = (row[C.make] ?? "").toString().trim();
      const model = (row[C.model] ?? "").toString().trim();
      let year = row[C.year]; if (year == null || year === "") year = row[C.year_to];
      const y = parseInt(year);
      const num = x => { const v=Number(x); return Number.isFinite(v)?v:null; }
      return {
        make, model, year: Number.isFinite(y)? y : null,
        engine: (row[C.engine] ?? "").toString().trim(),
        trans:  (row[C.trans] ?? "").toString().trim(),
        hp: num(row[C.hp]),
        body: (row[C.body] ?? "").toString().trim(),
        fuel: (row[C.fuel] ?? "").toString().trim(),
        drive: (row[C.drive] ?? "").toString().trim(),
        cylinders: num(row[C.cylinders]),
        disp: num(row[C.disp]),
        mpgCity: num(row[C.mpgC]),
        mpgHwy: num(row[C.mpgH]),
        msrp: num(row[C.msrp]),
        _raw: row
      };
    }

    function buildIndex(rows){
      const byMake = new Map();
      for(const r of rows){
        if(!r.make || !r.model || !r.year) continue;
        const m = r.make.toLowerCase();
        const mo = r.model.toLowerCase();
        if(!byMake.has(m)) byMake.set(m, new Map());
        const byModel = byMake.get(m);
        if(!byModel.has(mo)) byModel.set(mo, new Map());
        const byYear = byModel.get(mo);
        if(!byYear.has(r.year)) byYear.set(r.year, []);
        byYear.get(r.year).push(r);
      }
      return byMake;
    }

    // ===== MINI RISK MODEL =====
    function baselineFromVariant(v){
      let lambda0 = 0.017, cost0 = 560;
      const make = v.make.toLowerCase();
      const trans = (v.trans||"").toLowerCase();
      const engine = (v.engine||"").toLowerCase();
      if(["toyota","lexus"].includes(make)) { lambda0 = 0.012; cost0 = 540; }
      if(["honda","acura"].includes(make))  { lambda0 = 0.013; cost0 = 530; }
      if(["nissan","infiniti"].includes(make) && trans.includes("cvt")) { lambda0 = 0.022; cost0 = 580; }
      if(["bmw","mercedes-benz","audi","volkswagen"].includes(make)) { lambda0 = 0.019; cost0 = 680; }
      if(["subaru"].includes(make)) { lambda0 = 0.018; cost0 = 600; }
      if(["hyundai","kia"].includes(make)) { lambda0 = 0.017; cost0 = 560; }
      if(["ford","chevrolet","gmc","ram","dodge"].includes(make)) { lambda0 = 0.018; cost0 = 580; }
      if(trans.includes("cvt")) lambda0 *= 1.15;
      if(trans.includes("dual") || trans.includes("dct")) { lambda0 *= 1.10; cost0 += 60; }
      if(engine.includes("turbo")) lambda0 *= 1.08;
      if(engine.includes("hybrid")) cost0 += 40;
      if(engine.includes("diesel")) cost0 += 70;
      return { lambda0, cost0, label: `${v.make} ${v.model} ${v.year}` };
    }

    function scoreVehicle(platform, v){
      let lam = platform.lambda0, cost = platform.cost0;
      const why = [], flags = [];
      const mult = (f, note) => { lam *= f; if (note) why.push(`√ó${f.toFixed(2)} ‚Äî ${note}`); };
      const addCost = (c, note) => { cost += c; if (note) why.push(`${c>=0?"+":"-"}$${Math.abs(c)} ‚Äî ${note}`); };

      if (v.miles > 180000) mult(1.30, "Very high mileage");
      else if (v.miles > 120000) mult(1.25, "High mileage");
      else if (v.miles > 60000) mult(1.10, "Moderate mileage");

      const age = (new Date().getFullYear() - v.year);
      if (!isNaN(age) && age >= 12) mult(1.10, "Aging rubber/seals");

      if (v.region === "snow_belt"){ mult(1.15, "Rust/salt exposure"); addCost(120,"Rust prevention & fastener time"); flags.push("Snow-belt corrosion: inspect underbody & brake lines."); }

      if (v.owners === "3+") mult(1.10, "Multiple owners (variability)");

      if (v.maint === "excellent"){ mult(0.80, "Strong service records"); addCost(-100,"Well-maintained systems"); }
      else if (v.maint === "poor"){ mult(1.20, "Poor/missing records"); addCost(150,"Catch-up service likely"); }

      if (v.dtc === "yes"){ mult(1.30, "Active powertrain codes"); flags.push("Resolve CEL before purchase; verify readiness monitors."); }

      const trans = (v.trans||"").toLowerCase();
      if (trans.includes("cvt")){
        mult(1.20, "CVT thermal/shear risk");
        if (v.cooler === "yes"){ mult(0.95, "Aux cooler fitted"); flags.push("CVT cooler installed: modest risk reduction."); }
        else { flags.push("Consider CVT fluid + cooler kit to reduce heat."); }
      }

      if (v.timing === "yes"){ mult(0.92, "Timing system serviced"); }

      if (v.accident === "structural"){ mult(1.25, "Structural accident history"); flags.push("Check alignment printout & subframe points."); }
      else if (v.accident === "minor"){ mult(1.05, "Minor accident history"); }

      const longevity = Math.max(20, Math.min(98, Math.exp(-lam*5)*100));
      let conf = 0.85; if (v.maint === "poor") conf -= 0.15; if (v.dtc === "yes") conf -= 0.10;
      conf = Math.max(0.35, Math.min(0.95, conf));

      return { longevity, cost, flags: flags.slice(0,3), why, conf };
    }

    // ===== DATA =====
    let DATA = [], INDEX = null, COLS = null;

    async function loadData(){
      const res = await fetch(DATA_URL, {cache:"no-store"});
      if(!res.ok) throw new Error(`Failed to load JSON at ${DATA_URL} (${res.status})`);
      const raw = await res.json();
      if(!Array.isArray(raw)) throw new Error("JSON is not an array of records.");
      COLS = resolveCols(Object.keys(raw[0]));
      DATA = raw.map(r => normalizeRow(r, COLS)).filter(r => r.make && r.model && r.year);
      INDEX = buildIndex(DATA);
    }

    // ===== GUIDED FLOW =====
    const QUESTIONS = [
      { key:"goal", text:"What‚Äôs the main goal?", options:[
        {v:"reliable", label:"Ultra-reliable"},
        {v:"budget",   label:"Best value"},
        {v:"fun",      label:"Fun to drive"},
        {v:"family",   label:"Family / roomy"}
      ]},
      { key:"size", text:"What size are you thinking?", options:[
        {v:"compact", label:"Compact"},
        {v:"midsize", label:"Midsize"},
        {v:"suv",     label:"SUV/Crossover"},
        {v:"truck",   label:"Truck"},
        {v:"any",     label:"Surprise me"}
      ]},
      { key:"traction", text:"Need AWD/4√ó4?", options:[
        {v:"required", label:"Must have"},
        {v:"nice",     label:"Nice to have"},
        {v:"no",       label:"No preference"}
      ]},
      { key:"fuel", text:"Fuel preference?", options:[
        {v:"gas",    label:"Gas"},
        {v:"hybrid", label:"Hybrid"},
        {v:"diesel", label:"Diesel"},
        {v:"any",    label:"Any"}
      ]},
      { key:"trans", text:"Transmission?", options:[
        {v:"auto",   label:"Automatic"},
        {v:"manual", label:"Manual"},
        {v:"any",    label:"Any"}
      ]},
      { key:"years", text:"Model year range?", options:[
        {v:"newer",  label:"2015‚Äì2020"},
        {v:"middle", label:"2010‚Äì2014"},
        {v:"older",  label:"2005‚Äì2009"},
        {v:"any",    label:"1980‚Äì2020"}
      ]}
    ];

    let qi = 0, answers = {};

    function renderQ(){
      const q = QUESTIONS[qi];
      by("#qText").textContent = q.text;
      by("#qStep").textContent = `Step ${qi+1} of ${QUESTIONS.length}`;
      const box = by("#qOptions"); box.innerHTML = "";
      q.options.forEach(o=>{
        const b = el("button","rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-2 text-sm hover:bg-slate-100 dark:hover:bg-slate-800", o.label);
        b.onclick = () => { answers[q.key]=o.v; nextQ(); };
        box.appendChild(b);
      });
      by("#qBack").disabled = qi===0;
    }

    function nextQ(){
      if (qi < QUESTIONS.length-1){ qi++; renderQ(); return; }
      // done -> show picks
      by("#picksWrap").classList.remove("hidden");
      showPicks();
    }

    function pickCandidates(){
      const a = answers;
      const inYear = (y)=>{
        if(!y) return false;
        if(a.years==="newer")  return y>=2015 && y<=2020;
        if(a.years==="middle") return y>=2010 && y<=2014;
        if(a.years==="older")  return y>=2005 && y<=2009;
        return y>=1980 && y<=2020;
      };
      let rows = DATA.filter(r=>inYear(r.year));

      if(a.size && a.size!=="any"){
        const want = {
          compact:["hatch","compact","subcompact","small","sedan","coupe"],
          midsize:["midsize","mid-size","sedan","wagon","crossover"],
          suv:["suv","crossover","wagon"],
          truck:["truck","pickup"]
        }[a.size];
        rows = rows.filter(r=> (r.body||"").toLowerCase().split(/[\s\/-]+/).some(w=> want?.some(s=> w.includes(s))));
      }

      if(a.traction==="required"){
        rows = rows.filter(r=> (r.drive||"").toLowerCase().includes("awd") || (r.drive||"").toLowerCase().includes("4"));
      }

      if(a.fuel==="hybrid") rows = rows.filter(r=> (r.fuel||"").toLowerCase().includes("hybrid"));
      else if(a.fuel==="diesel") rows = rows.filter(r=> (r.fuel||"").toLowerCase().includes("diesel"));
      else if(a.fuel==="gas") rows = rows.filter(r=> !((r.fuel||"").toLowerCase().includes("diesel") || (r.fuel||"").toLowerCase().includes("electric")));

      if(a.trans==="manual") rows = rows.filter(r=> (r.trans||"").toLowerCase().includes("manual"));
      else if(a.trans==="auto") rows = rows.filter(r=> (r.trans||"").toLowerCase().includes("auto"));

      function goalScore(r){
        const base = baselineFromVariant(r);
        let s = 0;
        if(a.goal==="reliable") s += (1 - base.lambda0)*100;
        if(a.goal==="budget")   s += 60 - base.cost0/20;
        if(a.goal==="fun")      s += (r.hp||0)/10;
        if(a.goal==="family")   s += ((r.body||"").toLowerCase().includes("suv")?20:0) + ((r.body||"").toLowerCase().includes("wagon")?15:0);
        return s;
      }

      const uniq = new Map();
      for(const r of rows){
        const k = `${r.make}|${r.model}|${r.year}`;
        if(!uniq.has(k)) uniq.set(k, r);
      }
      const list = [...uniq.values()];
      list.sort((a,b)=> (goalScore(b)-goalScore(a)) || (b.year - a.year));
      return list.slice(0,5);
    }

    function showPicks(){
      const container = by("#picks"); container.innerHTML = "";
      const picks = pickCandidates();
      if(!picks.length){
        container.appendChild(el("div","rounded-lg border border-slate-200 dark:border-slate-800 p-3 text-sm text-slate-500","No matches. Try skipping a step."));
        return;
      }
      picks.forEach(r=>{
        const card = el("div","rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4");
        card.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div>
              <div class="font-extrabold">${r.year} ${r.make} ${r.model}</div>
              <div class="text-slate-500 dark:text-slate-400 text-sm">${r.engine || "Engine ‚Äî"} ‚Ä¢ ${r.trans || "Trans ‚Äî"} ‚Ä¢ ${r.body || "Body ‚Äî"}</div>
            </div>
            <button class="selectPick rounded-lg bg-brand px-3 py-1.5 font-semibold text-slate-900">Select</button>
          </div>`;
        card.querySelector(".selectPick").onclick = ()=> selectVehicle(r);
        container.appendChild(card);
      });
    }

    // ===== RESULTS =====
    let current = null; // normalized row for selection

    function selectVehicle(r){
      current = r;
      by("#qa").classList.add("hidden");
      by("#resultsCard").classList.remove("hidden");
      by("#selTitle").textContent = `${r.year} ${r.make} ${r.model}`;
      by("#selSub").textContent = `${r.engine || "Engine ‚Äî"} ‚Ä¢ ${r.trans || "Trans ‚Äî"} ‚Ä¢ ${r.body || "Body ‚Äî"}`;
      computeAndRender();
      window.scrollTo({top: by("#resultsCard").offsetTop - 8, behavior:"smooth"});
    }

    function computeAndRender(){
      if(!current) return;
      const base = baselineFromVariant(current);
      const v = {
        year: current.year,
        miles: Number(by("#miles").value),
        region: by("#region").value,
        owners: "2", // unknown here; could add later
        accident: "none",
        maint: by("#maint").value,
        dtc: by("#dtc").value,
        cooler: "no",
        timing: "no",
        trans: current.trans
      };
      const out = scoreVehicle(base, v);
      by("#longevity").textContent = out.longevity.toFixed(1) + "%";
      by("#cost").textContent = `${fmt$(out.cost)} ¬± 20%`;
      by("#confidence").textContent = Math.round(out.conf*100) + "%";
      by("#conf").textContent = base.label;

      const flags = by("#flags"); flags.innerHTML = "";
      (out.flags.length ? out.flags : ["No standout risks flagged from these basics. Get a pre-purchase inspection."]).forEach(f=>{
        const elDiv = el("div","rounded-lg border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 px-3 py-2 text-sm",`<span class="font-semibold text-amber-500">Risk/Tip:</span> ${f}`);
        flags.appendChild(elDiv);
      });

      const why = by("#why"); why.innerHTML = "";
      if (out.why.length){
        out.why.forEach(w=> why.appendChild(el("span","inline-block rounded-full border border-slate-300 dark:border-slate-700 px-2.5 py-1 text-xs",w)));
      } else {
        why.appendChild(el("div","text-xs text-slate-500 dark:text-slate-400","No major multipliers applied beyond baseline."));
      }

      const S = [
        ["Make", current.make],["Model", current.model],["Year", String(current.year)],
        ["Body", current.body || "‚Äî"],["Engine", current.engine || "‚Äî"],["Transmission", current.trans || "‚Äî"],
        ["Horsepower", current.hp!=null ? `${current.hp} hp` : "‚Äî"],
        ["Fuel", current.fuel || "‚Äî"],["Drivetrain", current.drive || "‚Äî"],
        ["Displacement", current.disp!=null ? `${current.disp} L` : "‚Äî"],
        ["Cylinders", current.cylinders!=null ? String(current.cylinders) : "‚Äî"],
        ["MPG (City/Highway)", (current.mpgCity!=null || current.mpgHwy!=null) ? `${current.mpgCity ?? "‚Äî"} / ${current.mpgHwy ?? "‚Äî"}` : "‚Äî"],
        ["MSRP (original)", current.msrp!=null ? fmt$(current.msrp) : "‚Äî"]
      ];
      const specs = by("#specs"); specs.innerHTML = "";
      for(const [k,vv] of S){
        const dt = el("div","font-medium text-slate-600 dark:text-slate-300",k);
        const dd = el("div","",vv);
        specs.appendChild(dt); specs.appendChild(dd);
      }
    }

    // Quick inputs recompute
    ["#miles","#region","#maint","#dtc"].forEach(sel=>{
      by(sel).addEventListener("change", computeAndRender);
      by(sel).addEventListener("input", computeAndRender);
    });

    // Buttons
    by("#start").onclick = () => {
      by("#qa").classList.remove("hidden");
      by("#picksWrap").classList.add("hidden");
      qi = 0; answers = {}; renderQ();
      window.scrollTo({top: by("#qa").offsetTop - 8, behavior:"smooth"});
    };
    by("#qBack").onclick = () => { if(qi>0){ qi--; renderQ(); } };
    by("#qSkip").onclick = () => { answers[QUESTIONS[qi].key] = "any"; nextQ(); };
    by("#change").onclick = () => { by("#resultsCard").classList.add("hidden"); by("#qa").classList.remove("hidden"); };

    // Theme toggle
    const tBtn = by("#themeToggle");
    const updateThemeBtn = () => tBtn.textContent = document.documentElement.classList.contains('dark') ? "‚òÄÔ∏è" : "üåô";
    tBtn.addEventListener("click", ()=>{
      const dark = !document.documentElement.classList.contains('dark');
      document.documentElement.classList.toggle('dark', dark);
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      updateThemeBtn();
    });
    updateThemeBtn();

    // Boot
    loadData().catch(err => alert("Failed to load Sh≈çmi JSON: " + err.message + "\nUpdate DATA_URL or check path."));
  </script>
</body>
</html>
