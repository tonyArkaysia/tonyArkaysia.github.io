<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>A_LABS ‚Äî Sh≈çmi: Used Car Truth Meter</title>
  <meta name="description" content="A_LABS Sh≈çmi: transparent longevity odds and maintenance expectations for used cars." />
  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind dark mode via class
    // Initialize from saved pref before paint
    (() => {
      const saved = localStorage.getItem('theme');
      const prefers = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (saved ? saved === 'dark' : prefers) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    })();
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { DEFAULT: '#5fd4a7' }
          }
        }
      },
      darkMode: 'class'
    }
  </script>
</head>
<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-900 dark:text-slate-100 selection:bg-brand/30">
  <div class="mx-auto max-w-5xl p-4 sm:p-6">
    <!-- Header -->
    <header class="flex items-center gap-3 mb-4">
      <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-cyan-400 to-brand shadow"></div>
      <div class="flex-1">
        <h1 class="text-xl font-bold">A_LABS ‚Äî Sh≈çmi: Used Car Truth Meter</h1>
        <p class="text-sm text-slate-600 dark:text-slate-400">Enriching Humanity Beyond Innovations ‚Ä¢ An A_LABS Product</p>
      </div>
      <button id="themeToggle" class="rounded-lg border border-slate-300 dark:border-slate-700 px-3 py-1.5 text-sm hover:bg-slate-100 dark:hover:bg-slate-800">
        üåô Dark
      </button>
    </header>

    <!-- Card -->
    <div class="rounded-2xl border border-slate-200 bg-white dark:bg-slate-950 dark:border-slate-800 shadow">
      <!-- Form -->
      <form id="form" class="p-4 sm:p-6 space-y-4 border-b border-slate-200 dark:border-slate-800">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Make</span>
            <select id="make" required class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="">Loading makes‚Ä¶</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Model</span>
            <select id="model" required disabled class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="">Select make first</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Year</span>
            <select id="year" required disabled class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="">Select model first</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Engine / Transmission</span>
            <select id="engtrans" disabled class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="">Auto-select</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Mileage</span>
            <input id="miles" required type="number" min="0" step="1000" placeholder="e.g., 160000"
              class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2" />
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Region</span>
            <select id="region" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="dry">Dry / Non-rust (AZ, NV, NM, SoCal)</option>
              <option value="snow_belt">Snow Belt / Coastal (salt exposure)</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Owners</span>
            <select id="owners" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option>1</option><option>2</option><option>3+</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Accident Severity</span>
            <select id="accident" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="none">None</option>
              <option value="minor">Minor</option>
              <option value="structural">Structural</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Maintenance Records</span>
            <select id="maint" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="excellent">Excellent (full receipts)</option>
              <option value="average" selected>Some</option>
              <option value="poor">Poor / missing</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Powertrain Codes (OBD-II)</span>
            <select id="dtc" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="no" selected>No active codes</option>
              <option value="yes">Yes (CEL on / pending)</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Transmission Cooler (CVT/auto)</span>
            <select id="cooler" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="no" selected>No / Unknown</option>
              <option value="yes">Yes (aux cooler)</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm font-semibold text-slate-600 dark:text-slate-400">Timing Chain/Belt Service Done</span>
            <select id="timing" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 p-2">
              <option value="no" selected>No / Unknown</option>
              <option value="yes">Yes (documented)</option>
            </select>
          </label>
        </div>

        <div class="flex items-center gap-3">
          <button class="inline-flex items-center gap-2 rounded-xl bg-brand px-4 py-2 font-semibold text-slate-900 shadow hover:opacity-90">
            <span>Calculate</span>
          </button>
          <span class="text-sm text-slate-500 dark:text-slate-400">Math: 5-yr survival = exp(‚àíannual hazard √ó 5). Adjustments shown below.</span>
        </div>
      </form>

      <!-- Results -->
      <div id="results" class="p-4 sm:p-6 hidden">
        <!-- KPI cards -->
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Longevity (5-Year Survival)</h3>
            <div id="longevity" class="text-3xl font-extrabold mt-1">‚Äî</div>
            <div id="conf" class="text-xs text-slate-500 dark:text-slate-400 mt-1">‚Äî</div>
          </div>
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Expected Annual Maintenance</h3>
            <div id="cost" class="text-3xl font-extrabold mt-1">‚Äî</div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Range reflects uncertainty (¬±20%).</div>
          </div>
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
            <h3 class="text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Data Confidence</h3>
            <div id="confidence" class="text-3xl font-extrabold mt-1">‚Äî</div>
            <div class="text-xs text-slate-500 dark:text-slate-400 mt-1">Improves with records & clean OBD-II.</div>
          </div>
        </div>

        <!-- Specs & Flags -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4">
          <!-- Car Specs Panel -->
          <div class="lg:col-span-2 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Car Specs</h3>
            <dl id="specs" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
              <!-- filled in JS -->
            </dl>
          </div>

          <!-- Risk Flags -->
          <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-950 p-4">
            <h3 class="text-sm font-semibold text-slate-700 dark:text-slate-300">Top Risk Flags</h3>
            <div id="flags" class="mt-3 space-y-2">
              <!-- filled in JS -->
            </div>
          </div>
        </div>

        <!-- Why -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-slate-600 dark:text-slate-400">Why these numbers? (show adjustments)</summary>
          <div id="why" class="mt-3 flex flex-wrap gap-2">
            <!-- chips inserted -->
          </div>
        </details>

        <div class="mt-6 text-xs text-slate-500 dark:text-slate-400">
          Data source: Sh≈çmi JSON (specs). Future: vPIC/IIHS/NHTSA live enrichment.
        </div>
      </div>
    </div>

    <footer class="text-center text-sm text-slate-500 dark:text-slate-400 mt-6">
      ¬© 2025 A_LABS ‚Äî Arkaysia Labs ‚Ä¢ <a href="https://tonyarkaysia.github.io" class="text-brand underline-offset-2 hover:underline">Visit A_LABS</a>
    </footer>
  </div>

  <script>
    // ===== Config =====
    const DATA_URL = "data/shomi/car_specs_1980_2020_major_makes.json";

    // ===== Helpers =====
    const by = (s) => document.querySelector(s);
    const opt = (v, t=v) => { const o=document.createElement("option"); o.value=v; o.textContent=t; return o; };
    const fmt$ = (n) => "$" + (Math.round(n/10)*10).toLocaleString();

    function resolveCols(cols){
      const lc = cols.map(c=>c.toLowerCase());
      const find = names => {
        for(const n of names){
          const i = lc.indexOf(n.toLowerCase());
          if(i>=0) return cols[i];
          for(let j=0;j<cols.length;j++){
            if(lc[j].includes(n.toLowerCase())) return cols[j];
          }
        }
        return null;
      };
      return {
        make: find(["Make","Manufacturer","Brand"]),
        model: find(["Model","Modle","Car","Model Name"]),
        year:  find(["Year","Model Year","Year_from","Year_from "]),
        year_to: find(["Year_to","Year to"]),
        engine: find(["Engine","Engine Info","Engine Type"]),
        trans:  find(["Transmission","Gearbox","Trans"]),
        hp:     find(["Horsepower","HP","Power"]),
        body:   find(["Body","Body_type","Body Style"]),
        torque: find(["Torque","Nm","Torque (Nm)"]),
        fuel:   find(["Fuel Type","Fuel","FuelType"]),
        drive:  find(["Drivetrain","Drive","Drive Type"]),
        cylinders: find(["Cylinders","Cylinder"]),
        disp:   find(["Displacement","Engine Displacement (L)","Liters"]),
        mpgC:   find(["City MPG","MPG City","City_mpg","city_mpg"]),
        mpgH:   find(["Highway MPG","MPG Highway","Highway_mpg","highway_mpg"]),
        msrp:   find(["MSRP","Price","price","List Price"])
      };
    }

    function normalizeRow(row, C){
      const make = (row[C.make] ?? "").toString().trim();
      const model = (row[C.model] ?? "").toString().trim();
      let year = row[C.year];
      if (year == null || year === "") year = row[C.year_to];
      const y = parseInt(year);
      const num = (x) => {
        const v = Number(x);
        return Number.isFinite(v) ? v : null;
      };
      return {
        make, model, year: Number.isFinite(y)? y : null,
        engine: (row[C.engine] ?? "").toString().trim(),
        trans:  (row[C.trans] ?? "").toString().trim(),
        hp: num(row[C.hp]),
        torque: num(row[C.torque]),
        fuel: (row[C.fuel] ?? "").toString().trim(),
        drive: (row[C.drive] ?? "").toString().trim(),
        cylinders: num(row[C.cylinders]),
        disp: num(row[C.disp]),
        mpgCity: num(row[C.mpgC]),
        mpgHwy: num(row[C.mpgH]),
        msrp: num(row[C.msrp]),
        body: (row[C.body] ?? "").toString().trim(),
        _raw: row
      };
    }

    function buildIndex(rows){
      const byMake = new Map();
      for(const r of rows){
        if(!r.make || !r.model || !r.year) continue;
        const m = r.make.toLowerCase();
        const mo = r.model.toLowerCase();
        if(!byMake.has(m)) byMake.set(m, new Map());
        const byModel = byMake.get(m);
        if(!byModel.has(mo)) byModel.set(mo, new Map());
        const byYear = byModel.get(mo);
        if(!byYear.has(r.year)) byYear.set(r.year, []);
        byYear.get(r.year).push(r);
      }
      return byMake;
    }

    function baselineFromVariant(v){
      let lambda0 = 0.017, cost0 = 560;
      const make = v.make.toLowerCase();
      const trans = (v.trans||"").toLowerCase();
      const engine = (v.engine||"").toLowerCase();
      if(["toyota","lexus"].includes(make)) { lambda0 = 0.012; cost0 = 540; }
      if(["honda","acura"].includes(make))  { lambda0 = 0.013; cost0 = 530; }
      if(["nissan","infiniti"].includes(make) && trans.includes("cvt")) { lambda0 = 0.022; cost0 = 580; }
      if(["bmw","mercedes-benz","audi","volkswagen"].includes(make)) { lambda0 = 0.019; cost0 = 680; }
      if(["subaru"].includes(make)) { lambda0 = 0.018; cost0 = 600; }
      if(["hyundai","kia"].includes(make)) { lambda0 = 0.017; cost0 = 560; }
      if(["ford","chevrolet","gmc","ram","dodge"].includes(make)) { lambda0 = 0.018; cost0 = 580; }
      if(trans.includes("cvt")) lambda0 *= 1.15;
      if(trans.includes("dual") || trans.includes("dct")) { lambda0 *= 1.10; cost0 += 60; }
      if(engine.includes("turbo")) lambda0 *= 1.08;
      if(engine.includes("hybrid")) cost0 += 40;
      if(engine.includes("diesel")) cost0 += 70;
      return { lambda0, cost0, label: `${v.make} ${v.model} ${v.year}` };
    }

    function scoreVehicle(platform, v){
      let lam = platform.lambda0;
      let cost = platform.cost0;
      const why = [], flags = [];
      const mult = (f, note) => { lam *= f; if (note) why.push(`√ó${f.toFixed(2)} ‚Äî ${note}`); };
      const addCost = (c, note) => { cost += c; if (note) why.push(`${c>=0?"+":"-"}$${Math.abs(c)} ‚Äî ${note}`); };

      if (v.miles > 180000) mult(1.30, "Very high mileage");
      else if (v.miles > 120000) mult(1.25, "High mileage");
      else if (v.miles > 60000) mult(1.10, "Moderate mileage");

      const age = (new Date().getFullYear() - v.year);
      if (!isNaN(age) && age >= 12) mult(1.10, "Older rubber/seals/heat cycles");

      if (v.region === "snow_belt"){ mult(1.15, "Rust/salt exposure"); addCost(120,"Rust prevention & fastener time"); flags.push("Snow-belt corrosion: underbody/lines inspection recommended."); }

      if (v.owners === "3+") mult(1.10, "Multiple owners (variability)");

      if (v.maint === "excellent"){ mult(0.80, "Strong service records"); addCost(-100,"Well-maintained systems"); }
      else if (v.maint === "poor"){ mult(1.20, "Poor/missing records"); addCost(150,"Catch-up service likely"); }

      if (v.dtc === "yes"){ mult(1.30, "Active powertrain codes"); flags.push("Fix current CEL before purchase; may hide readiness issues."); }

      const trans = (v.trans||"").toLowerCase();
      if (trans.includes("cvt")){
        mult(1.20, "CVT thermal/shear risk");
        if (v.cooler === "yes"){ mult(0.95, "Aux cooler fitted"); flags.push("CVT cooler installed: modest risk reduction."); }
        else { flags.push("Consider CVT fluid + cooler kit to reduce heat."); }
      }

      if (v.timing === "yes"){ mult(0.92, "Timing system serviced"); }

      if (v.accident === "structural"){ mult(1.25, "Structural accident history"); flags.push("Inspect subframe & alignment readings."); }
      else if (v.accident === "minor"){ mult(1.05, "Minor accident history"); }

      const longevity = Math.max(20, Math.min(98, Math.exp(-lam * 5) * 100));
      let conf = 0.85; if (v.maint === "poor") conf -= 0.15; if (v.dtc === "yes") conf -= 0.10;
      conf = Math.max(0.35, Math.min(0.95, conf));

      return { longevity, cost, flags: flags.slice(0,3), why, conf };
    }

    // ===== State & Load =====
    let DATA = [], INDEX = null, COLS = null;

    async function loadData(){
      const res = await fetch(DATA_URL, {cache:"no-store"});
      if(!res.ok) throw new Error(`Failed to load JSON at ${DATA_URL} (${res.status})`);
      const raw = await res.json();
      if(!Array.isArray(raw)) throw new Error("JSON is not an array of records.");
      COLS = resolveCols(Object.keys(raw[0]));
      DATA = raw.map(r => normalizeRow(r, COLS)).filter(r => r.make && r.model && r.year);
      INDEX = buildIndex(DATA);

      // Populate makes
      const makeSel = by("#make"); makeSel.innerHTML = "";
      const makes = [...INDEX.keys()].map(m=>m[0].toUpperCase()+m.slice(1)).sort((a,b)=>a.localeCompare(b));
      makeSel.append(opt("", "Select make"));
      for(const m of makes) makeSel.append(opt(m, m));
      makeSel.disabled = false;

      // Reset dependents
      by("#model").innerHTML = `<option value="">Select make first</option>`; by("#model").disabled = true;
      by("#year").innerHTML = `<option value="">Select model first</option>`; by("#year").disabled = true;
      by("#engtrans").innerHTML = `<option value="">Auto-select</option>`; by("#engtrans").disabled = true;
    }

    // ===== UI Events =====
    by("#make").addEventListener("change", ()=>{
      const make = by("#make").value.toLowerCase();
      const modelSel = by("#model"); modelSel.innerHTML = "";
      if(!make || !INDEX.has(make)){ modelSel.append(opt("", "Select make first")); modelSel.disabled = true; return; }
      const byModel = INDEX.get(make);
      const models = [...byModel.keys()].map(m=>m[0].toUpperCase()+m.slice(1)).sort((a,b)=>a.localeCompare(b));
      modelSel.append(opt("", "Select model"));
      for(const mo of models) modelSel.append(opt(mo, mo));
      modelSel.disabled = false;

      by("#year").innerHTML = `<option value="">Select model first</option>`; by("#year").disabled = true;
      by("#engtrans").innerHTML = `<option value="">Auto-select</option>`; by("#engtrans").disabled = true;
    });

    by("#model").addEventListener("change", ()=>{
      const make = by("#make").value.toLowerCase();
      const model = by("#model").value.toLowerCase();
      const yearSel = by("#year"); yearSel.innerHTML = "";
      const byModel = INDEX.get(make);
      if(!byModel || !byModel.has(model)){ yearSel.append(opt("", "Select model first")); yearSel.disabled = true; return; }
      const byYear = byModel.get(model);
      const years = [...byYear.keys()].sort((a,b)=>a-b);
      yearSel.append(opt("", "Select year"));
      for(const y of years) yearSel.append(opt(String(y), String(y)));
      yearSel.disabled = years.length === 0;

      by("#engtrans").innerHTML = `<option value="">Auto-select</option>`; by("#engtrans").disabled = true;
    });

    by("#year").addEventListener("change", ()=>{
      const make = by("#make").value.toLowerCase();
      const model = by("#model").value.toLowerCase();
      const year  = parseInt(by("#year").value);
      const byModel = INDEX.get(make);
      const variants = byModel.get(model).get(year) || [];
      const engSel = by("#engtrans"); engSel.innerHTML = ""; engSel.append(opt("", "Auto-select"));
      const seen = new Set();
      for(const v of variants){
        const label = `${v.engine || "Engine N/A"} ‚Äî ${v.trans || "Trans N/A"}`;
        const key = label.toLowerCase();
        if(seen.has(key)) continue; seen.add(key);
        engSel.append(opt(JSON.stringify({engine:v.engine||"",trans:v.trans||""}), label));
      }
      engSel.disabled = false;
    });

    by("#form").addEventListener("submit", (e)=>{
      e.preventDefault();
      // Variant selection
      let engine="", trans="";
      const engVal = by("#engtrans").value;
      if(engVal){ try { const obj = JSON.parse(engVal); engine = obj.engine; trans = obj.trans; } catch {} }
      else {
        const byModel = INDEX.get(by("#make").value.toLowerCase());
        const list = byModel?.get(by("#model").value.toLowerCase())?.get(parseInt(by("#year").value)) || [];
        if(list.length){ engine = list[0].engine || ""; trans = list[0].trans || ""; }
      }

      const variant = { make: by("#make").value, model: by("#model").value, year: parseInt(by("#year").value), engine, trans };
      const base = baselineFromVariant(variant);
      const v = {
        year: variant.year,
        miles: Number(by("#miles").value),
        region: by("#region").value,
        owners: by("#owners").value,
        accident: by("#accident").value,
        maint: by("#maint").value,
        dtc: by("#dtc").value,
        cooler: by("#cooler").value,
        timing: by("#timing").value,
        trans: variant.trans
      };
      const out = scoreVehicle(base, v);

      // KPIs
      by("#results").classList.remove("hidden");
      by("#longevity").textContent = out.longevity.toFixed(1) + "%";
      by("#cost").textContent = `${fmt$(out.cost)} ¬± 20%`;
      const confPct = Math.round((0.85) * (v.maint==="excellent"?1: v.maint==="poor"?0.7:0.85) * (v.dtc==="yes"?0.8:1) * 100);
      by("#confidence").textContent = confPct + "%";
      by("#conf").textContent = base.label + (variant.engine||variant.trans?` ‚Äî ${variant.engine||""}${variant.trans?(" / "+variant.trans):""}`:"");

      // Flags
      const flags = by("#flags"); flags.innerHTML = "";
      (out.flags.length?out.flags:["No standout risks detected in basic inputs. Always pre-purchase inspect."]).forEach(f=>{
        const el = document.createElement("div");
        el.className = "rounded-lg border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900 px-3 py-2 text-sm";
        el.innerHTML = `<span class="font-semibold text-amber-500">Risk/Tip:</span> ${f}`;
        flags.appendChild(el);
      });

      // Why chips
      const why = by("#why"); why.innerHTML = "";
      if (out.why.length){
        out.why.forEach(w=>{
          const chip = document.createElement("span");
          chip.className = "inline-block rounded-full border border-slate-300 dark:border-slate-700 px-2.5 py-1 text-xs";
          chip.textContent = w;
          why.appendChild(chip);
        });
      } else {
        const small = document.createElement("div");
        small.className = "text-xs text-slate-500 dark:text-slate-400";
        small.textContent = "No major multipliers applied beyond baseline.";
        why.appendChild(small);
      }

      // Specs panel (populate from a representative row)
      const byModel = INDEX.get(by("#make").value.toLowerCase());
      const list = byModel?.get(by("#model").value.toLowerCase())?.get(parseInt(by("#year").value)) || [];
      const r = list.find(x => (x.engine||"") === engine && (x.trans||"") === trans) || list[0];
      const S = [
        ["Make", variant.make],
        ["Model", variant.model],
        ["Year", String(variant.year || "")],
        ["Body", r?.body || "‚Äî"],
        ["Engine", r?.engine || "‚Äî"],
        ["Transmission", r?.trans || "‚Äî"],
        ["Horsepower", r?.hp != null ? `${r.hp} hp` : "‚Äî"],
        ["Torque", r?.torque != null ? `${r.torque} Nm` : "‚Äî"],
        ["Displacement", r?.disp != null ? `${r.disp} L` : "‚Äî"],
        ["Cylinders", r?.cylinders != null ? String(r.cylinders) : "‚Äî"],
        ["Fuel", r?.fuel || "‚Äî"],
        ["Drivetrain", r?.drive || "‚Äî"],
        ["MPG (City/Highway)", (r?.mpgCity!=null || r?.mpgHwy!=null) ? `${r?.mpgCity ?? "‚Äî"} / ${r?.mpgHwy ?? "‚Äî"}` : "‚Äî"],
        ["MSRP (original)", r?.msrp != null ? fmt$(r.msrp) : "‚Äî"]
      ];
      const specs = by("#specs"); specs.innerHTML = "";
      for(const [k,vv] of S){
        const dt = document.createElement("div");
        dt.className = "font-medium text-slate-600 dark:text-slate-300";
        dt.textContent = k;
        const dd = document.createElement("div");
        dd.className = "text-slate-900 dark:text-slate-100";
        dd.textContent = vv;
        specs.appendChild(dt); specs.appendChild(dd);
      }

      window.scrollTo({top: document.querySelector("#results").offsetTop - 8, behavior:"smooth"});
    });

    // Theme toggle
    const themeBtn = by("#themeToggle");
    const updateThemeBtn = () => {
      const dark = document.documentElement.classList.contains('dark');
      themeBtn.textContent = dark ? "‚òÄÔ∏è" : "üåô";
    };
    themeBtn.addEventListener("click", ()=>{
      document.documentElement.classList.toggle('dark');
      const dark = document.documentElement.classList.contains('dark');
      localStorage.setItem('theme', dark ? 'dark' : 'light');
      updateThemeBtn();
    });
    updateThemeBtn();

    // Start
    loadData().catch(err => alert("Failed to load Sh≈çmi JSON: " + err.message + "\nUpdate DATA_URL or check path."));
  </script>
</body>
</html>
